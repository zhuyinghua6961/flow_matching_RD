# Flow Matching RD图 Sim2Real V3 版本说明

## V3版本新增功能

V3版本在V2版本基础上，新增了以下功能：

### 1. 综合评分系统 ⭐⭐⭐⭐⭐

- **综合评分计算**：基于多个指标计算0-100分的综合评分
- **评分公式**：
  ```
  总分 = 60 × 频域得分 + 25 × SSIM得分 + 15 × PSNR得分
  ```
- **评级系统**：自动评级（优秀/良好/一般/需改进/较差）

### 2. 完整的评估指标 ⭐⭐⭐⭐⭐

新增指标：
- **频域相关系数**（核心指标）：评估多普勒效应学习效果
- **频域MSE**：频域幅度谱的MSE
- **频域PSNR**：频域幅度谱的PSNR
- **MAE**：平均绝对误差
- **能量分布相似度**：基于直方图的Bhattacharyya系数

### 3. PSNR动态范围确定 ⭐⭐⭐⭐

- **训练时收集PSNR历史**：在验证阶段自动收集PSNR值
- **动态范围计算**：基于历史数据计算PSNR范围（P5-P95百分位数）
- **保存到检查点**：PSNR范围保存到模型检查点中
- **测试时自动使用**：测试时从检查点加载PSNR范围，用于评分归一化

### 4. 训练后自动测试 ⭐⭐⭐⭐⭐

- **自动加载测试集**：训练时自动加载测试集（如果启用）
- **训练结束后自动评估**：训练完成后自动在测试集上评估
- **输出综合评分**：自动输出测试集的综合评分和评级
- **配置开关**：可通过配置文件控制是否启用自动测试

## 文件结构

```
flow_matching_RD/
├── utils_v3/              # V3版本的工具模块
│   ├── __init__.py
│   ├── metrics.py         # 评估指标模块
│   └── evaluator.py       # 评估器模块
├── train_v3.py            # V3训练脚本
├── test_v3.py             # V3测试脚本
└── README_V3.md           # V3版本说明（本文件）
```

## 使用方法

### 1. 训练（带自动测试）

```bash
python train_v3.py --config config_v2.yaml
```

在配置文件中启用自动测试：
```yaml
train:
  auto_test: true  # 启用自动测试
```

### 2. 单独测试

```bash
python test_v3.py \
    --checkpoint trained_models/outputs_117/checkpoints/best_model.pth \
    --save_results \
    --output_dir test_results/
```

## 配置文件说明

### 新增配置项

```yaml
train:
  auto_test: true  # 是否在训练结束后自动测试（默认false）
```

### 使用现有配置

V3版本完全兼容V2版本的配置文件，可以直接使用`config_v2.yaml`。

## 评估指标说明

### 核心指标

1. **频域相关系数（Freq Correlation）**
   - 范围：[-1, 1]
   - 意义：评估多普勒效应学习效果
   - 目标：> 0.8（优秀）

2. **SSIM**
   - 范围：[0, 1]
   - 意义：结构相似性
   - 目标：> 0.85（优秀）

3. **PSNR**
   - 单位：dB
   - 意义：峰值信噪比
   - 目标：> 25 dB（良好）

### 综合评分标准

- **90-100分**：优秀
  - 频域相关系数 > 0.8
  - SSIM > 0.85
  - PSNR > 30 dB

- **80-90分**：良好
  - 频域相关系数 0.7-0.8
  - SSIM > 0.80
  - PSNR > 25 dB

- **70-80分**：一般
  - 频域相关系数 0.6-0.7
  - SSIM > 0.75
  - PSNR > 20 dB

- **60-70分**：需改进
  - 频域相关系数 < 0.6
  - 需要重新训练或调整参数

- **< 60分**：较差
  - 频域特征学习不足
  - 需要重新训练

## PSNR动态范围

### 工作原理

1. **训练阶段**：
   - 每个epoch的验证阶段计算PSNR
   - 收集所有PSNR值到历史记录

2. **训练结束**：
   - 计算PSNR范围（P5-P95百分位数）
   - 保存到模型检查点

3. **测试阶段**：
   - 从检查点加载PSNR范围
   - 使用动态范围进行PSNR归一化

### 优势

- **自适应**：根据数据集特性自动调整
- **公平评估**：不同数据集使用不同的归一化范围
- **准确反映**：更能反映模型在该数据集上的表现

## 输出示例

### 训练完成后自动测试输出

```
============================================================
开始测试集评估...
============================================================
  ODE步数: 50
  ODE方法: euler
  PSNR范围: [18.5, 32.3] dB

测试集评估: 100%|██████████| 39/39 [00:45<00:00]

============================================================
综合评分报告
============================================================
总分: 82.5 / 100
评级: 良好

评分明细:
  频域得分: 49.4 / 60
    - 频域相关系数: 0.8234
  SSIM得分: 21.9 / 25
    - SSIM值: 0.8765
  PSNR得分: 12.1 / 15
    - PSNR值: 29.12 dB
    - PSNR范围: [18.5, 32.3] dB
============================================================
```

### 单独测试输出

```bash
python test_v3.py --checkpoint best_model.pth --save_results
```

输出包含：
- 基础指标（MSE, MAE, PSNR, SSIM）
- 频域指标（Freq MSE, Freq PSNR, Freq Correlation）
- 其他指标（Energy Similarity）
- **综合评分和评级**

## 与V2版本的兼容性

- **完全兼容**：V3版本可以加载V2版本训练的模型
- **配置文件**：可以直接使用V2的配置文件
- **向后兼容**：如果检查点中没有PSNR范围，使用默认范围[15, 35] dB

## 注意事项

1. **自动测试会增加训练时间**：测试评估需要额外时间（约2-5分钟）
2. **PSNR范围**：首次训练时PSNR范围基于验证集数据，后续会逐步优化
3. **评分权重**：当前权重（60/25/15）基于训练目标设计，可根据需要调整

## 技术细节

### 评估指标模块（utils_v3/metrics.py）

- `ImageQualityMetrics`：评估指标集合类
- `compute_metrics()`：计算所有指标
- 支持PyTorch tensor和numpy array输入

### 评估器模块（utils_v3/evaluator.py）

- `ModelEvaluator`：模型评估器类
- `calculate_score()`：计算综合评分
- `format_score_report()`：格式化评分报告

### 训练脚本（train_v3.py）

- 继承V2版本的所有功能
- 新增PSNR历史收集
- 新增自动测试评估
- 新增PSNR范围保存

### 测试脚本（test_v3.py）

- 完整的评估指标计算
- 综合评分计算
- 详细的评分报告输出

## 总结

V3版本在保持V2版本所有功能的基础上，新增了：
1. ✅ 完整的评估指标系统
2. ✅ 综合评分和评级系统
3. ✅ PSNR动态范围确定
4. ✅ 训练后自动测试评估

这些功能使得模型评估更加全面、准确和自动化。

