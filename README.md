# Flow Matching RDå›¾ Sim2Real æ˜ å°„

åŸºäº **Flow Matching + ControlNet + UNet** çš„è½»é‡çº§æ— äººæœºé›·è¾¾RDå›¾ä»¿çœŸåˆ°çœŸå®åŸŸæ˜ å°„æ¨¡å‹ã€‚

---

## ğŸ¯ é¡¹ç›®ç®€ä»‹

å°†ä»¿çœŸç”Ÿæˆçš„æ— äººæœºé›·è¾¾RDå›¾è½¬æ¢ä¸ºçœŸå®åŸŸRDå›¾ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… **è½»é‡åŒ–è®¾è®¡**ï¼šæ€»å‚æ•°é‡ ~25Mï¼Œé€‚åˆå•å¡è®­ç»ƒ
- âœ… **ç²¾ç¡®ä½ç½®æ§åˆ¶**ï¼šåŸºäºçƒ­åŠ›å›¾çš„ControlNetå¼•å¯¼
- âœ… **Flow Matching**ï¼šè®­ç»ƒç¨³å®šï¼Œæ¨ç†é«˜æ•ˆï¼ˆ20æ­¥ï¼‰
- âœ… **é’ˆå¯¹æ€§Loss**ï¼šåŠ æƒæŸå¤±ä¸“ä¸ºRDå›¾ç¨€ç–ç›®æ ‡ä¼˜åŒ–

---

## ğŸ—ï¸ æ¨¡å‹æ¶æ„

### æ•´ä½“æµç¨‹

```
è®­ç»ƒæ—¶ï¼š
sim_RD + real_RD + prompt
    â†“
Prompt â†’ çƒ­åŠ›å›¾ç”Ÿæˆ (è§„åˆ™æå–ï¼Œæ— éœ€è®­ç»ƒ)
    â†“
[ControlNet] sim_RD + Heatmap â†’ æ¡ä»¶ç‰¹å¾
    â†“ (æ³¨å…¥)
[UNet] Flow Matchingé€Ÿåº¦åœºé¢„æµ‹
    â†“
åŠ æƒLossä¼˜åŒ–

æ¨ç†æ—¶ï¼š
sim_RD + prompt â†’ ODEæ±‚è§£ â†’ real_RD
```

### 1. UNetä¸»å¹²

**å‚æ•°é…ç½®**ï¼š
- åŸºç¡€é€šé“æ•°: 64
- é€šé“å€æ•°: (1, 2, 4, 8) â†’ [64, 128, 256, 512]
- ä¸‹é‡‡æ ·å±‚æ•°: 3å±‚
- ResBlockæ•°: æ¯å±‚2ä¸ª
- æ³¨æ„åŠ›æœºåˆ¶: ä»…åœ¨ä½åˆ†è¾¨ç‡å±‚ (64Ã—64, 32Ã—32)
- æ€»å‚æ•°: ~18M

**ç‰¹ç‚¹**ï¼š
- è½»é‡åŒ–è®¾è®¡ï¼ˆç›¸æ¯”æ ‡å‡†UNetå‡å°‘40%å‚æ•°ï¼‰
- è·³è·ƒè¿æ¥ä¿ç•™ç©ºé—´ç»†èŠ‚
- Self-Attentionå¢å¼ºå…¨å±€æ„ŸçŸ¥

### 2. ControlNetåˆ†æ”¯

**å‚æ•°é…ç½®**ï¼š
- åŸºç¡€é€šé“æ•°: 32ï¼ˆUNetçš„ä¸€åŠï¼‰
- é•œåƒUNetç¼–ç å™¨ç»“æ„
- Zero-Convolutionåˆå§‹åŒ–ï¼ˆè®­ç»ƒç¨³å®šï¼‰
- æ€»å‚æ•°: ~7M

**è¾“å…¥**ï¼š`concat[sim_RD(3é€šé“), heatmap(1é€šé“)]` â†’ 4é€šé“

**è¾“å‡º**ï¼šå¤šå°ºåº¦ç‰¹å¾å›¾æ³¨å…¥UNetå¯¹åº”å±‚

### 3. çƒ­åŠ›å›¾ç”Ÿæˆå™¨

**å®Œå…¨è§„åˆ™åŒ–ï¼Œæ— è®­ç»ƒå‚æ•°**ï¼š

1. **Promptè§£æ** â†’ æå–é€Ÿåº¦ã€è·ç¦»å‚æ•°
2. **ç‰©ç†åæ ‡ â†’ åƒç´ åæ ‡**ï¼š
   - Xè½´ï¼šé€Ÿåº¦ â†’ æ¨ªå‘åƒç´  (ä¸­å¿ƒ=0m/s)
   - Yè½´ï¼šè·ç¦» â†’ çºµå‘åƒç´  (é¡¶éƒ¨=0m)
3. **é«˜æ–¯çƒ­åŠ›å›¾**ï¼šÏƒ=10ï¼Œå½’ä¸€åŒ–åˆ°[0,1]
4. **å¤šç›®æ ‡**ï¼šå¤šä¸ªé«˜æ–¯å³°å–æœ€å¤§å€¼å åŠ 

**æ”¯æŒæ ¼å¼**ï¼š
- å•/åŒ/ä¸‰ç›®æ ‡ï¼š`radar-RD-map; ... target number = 2, ...`
- ç®€å•æ ¼å¼ï¼š`é€Ÿåº¦: 5m/s, è·ç¦»: 100m`

---

## ğŸ“ æŸå¤±å‡½æ•°

### åŠ æƒFlow Matching Loss

**æ ‡å‡†Flow Matching**ï¼š
```
L_fm = ||v_Î¸(x_t, t) - (x_1 - x_0)||Â²
```
å…¶ä¸­ï¼š
- x_0 = sim_RD (æºåŸŸ)
- x_1 = real_RD (ç›®æ ‡åŸŸ)
- x_t = (1-t)Â·x_0 + tÂ·x_1 + ÏƒÂ·Îµ (æ’å€¼è·¯å¾„)
- v_Î¸ = æ¨¡å‹é¢„æµ‹çš„é€Ÿåº¦åœº

**åŠ æƒç­–ç•¥**ï¼š

```python
# ä»çƒ­åŠ›å›¾ç”Ÿæˆæƒé‡å›¾
weight_map = MaxPool(heatmap) > threshold
weight_map = weight_map * weight_factor + 1.0

# åŠ æƒLoss
loss = (weight_map * (pred - target)Â²).mean()
```

**å…³é”®å‚æ•°**ï¼š
- `weight_factor`: ç›®æ ‡åŒºåŸŸæƒé‡ï¼ˆé»˜è®¤50ï¼‰
- `threshold`: çƒ­åŠ›å›¾é˜ˆå€¼ï¼ˆé»˜è®¤0.1ï¼‰
- `MaxPool`: ä¿ç•™å³°å€¼åŒºåŸŸ

**ä¸ºä»€ä¹ˆéœ€è¦åŠ æƒ**ï¼š
- RDå›¾ä¸­ç›®æ ‡å æ¯” < 1%
- æ ‡å‡†MSEä¼šè¢«èƒŒæ™¯ä¸»å¯¼
- åŠ æƒLosså¼ºåˆ¶æ¨¡å‹å…³æ³¨ç›®æ ‡åŒºåŸŸ

**æ•ˆæœå¯¹æ¯”**ï¼š
```
æ ‡å‡†Loss: èƒŒæ™¯ç²¾ç»†ï¼Œç›®æ ‡æ¨¡ç³Š
åŠ æƒLoss: ç›®æ ‡æ¸…æ™°ï¼ŒèƒŒæ™¯ç¨å·®ï¼ˆå¯æ¥å—ï¼‰
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

```bash
pip install -r requirements.txt
```

**ä¸»è¦ä¾èµ–**ï¼š
- PyTorch >= 2.0
- torchvision
- numpy
- Pillow
- PyYAML

### 2. æ•°æ®å‡†å¤‡

```
data/
â”œâ”€â”€ sim/              # ä»¿çœŸRDå›¾
â”‚   â”œâ”€â”€ rd001.png
â”‚   â””â”€â”€ ...
â”œâ”€â”€ real/             # çœŸå®RDå›¾
â”‚   â”œâ”€â”€ rd001.png
â”‚   â””â”€â”€ ...
â””â”€â”€ prompt/           # æç¤ºè¯ï¼ˆæ¯ä¸ªå›¾ç‰‡ä¸€ä¸ªtxtï¼‰
    â”œâ”€â”€ rd001.txt
    â””â”€â”€ ...
```

**Promptç¤ºä¾‹** (`rd001.txt`):
```
radar-RD-map; Turbo rendering; coordinates: top is near, bottom is far, left is negative, right is positive. target number = 1, the first target: distance = 102m, velocity = 20.00m/s.
```

### 3. è®­ç»ƒ

```bash
python train.py --data_root ./data
```

### 4. æ¨ç†

```bash
python inference.py \
  --checkpoint ./checkpoints/best_model.pth \
  --sim_rd ./test.png \
  --prompt "é€Ÿåº¦: 5m/s, è·ç¦»: 100m" \
  --output ./result.png
```

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- **[TRAINING_GUIDE.md](TRAINING_GUIDE.md)** - å®Œæ•´è®­ç»ƒæŒ‡å—ï¼ˆæ•°æ®å‡†å¤‡ã€å‚æ•°é…ç½®ã€å‘½ä»¤è¡Œç”¨æ³•ï¼‰
- **[config.yaml](config.yaml)** - é…ç½®æ–‡ä»¶è¯´æ˜

---

## ğŸ“Š é¡¹ç›®ç»“æ„

```
flow_matching_RD/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ unet.py              # UNetä¸»å¹²
â”‚   â”œâ”€â”€ controlnet.py        # ControlNetåˆ†æ”¯
â”‚   â””â”€â”€ flow_matching.py     # Flow Matchingå°è£…
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ dataset.py           # æ•°æ®åŠ è½½å™¨
â”‚   â”œâ”€â”€ heatmap.py           # çƒ­åŠ›å›¾ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ loss.py              # åŠ æƒæŸå¤±å‡½æ•°
â”‚   â””â”€â”€ early_stopping.py    # æ—©åœæœºåˆ¶
â”œâ”€â”€ config.yaml              # é…ç½®æ–‡ä»¶
â”œâ”€â”€ train.py                 # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ inference.py             # æ¨ç†è„šæœ¬
â””â”€â”€ README.md
```

---

## ğŸ“ å¼•ç”¨

æœ¬é¡¹ç›®åŸºäºä»¥ä¸‹å·¥ä½œï¼š
- Flow Matching: [Flow Matching for Generative Modeling](https://arxiv.org/abs/2210.02747)
- ControlNet: [Adding Conditional Control to Text-to-Image Diffusion Models](https://arxiv.org/abs/2302.05543)

---

**æ›´æ–°æ—¥æœŸ**: 2025-10-29
