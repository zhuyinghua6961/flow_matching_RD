# Flow Matching RD图 Sim2Real V3 配置文件 - 真正的对抗训练
# 使用AdversarialDiscriminator进行真正的GAN对抗训练

# ========== 模型配置 ==========
model:
  base_channels: 64                     # 基础通道数
  channel_mult: [1, 2, 4, 8]            # 通道倍数 [64, 128, 256, 512]
  time_embed_dim: 256                   # 时间嵌入维度
  num_res_blocks: 2                     # 每层残差块数量
  attention_levels: []                  # 使用attention的层级
  dropout: 0.1                          # Dropout概率

# ========== 数据配置 ==========
data:
  train_root: "./new_dataset/train"
  val_root: "./new_dataset/val"
  test_root: "./new_dataset/test"
  
  image_size: 512
  channels: 1
  
  augment: true
  
  normalize_mean: 0.35
  normalize_std: 0.06

# ========== Loss配置 ==========
loss:
  # Perceptual Loss（关闭）
  use_perceptual: false
  perceptual_weight: 0.0
  perceptual_interval: 50
  perceptual_layers: [3, 8, 15]
  
  # 频域Loss（核心⭐⭐⭐⭐⭐）
  use_frequency: true
  frequency_weight: 2.0                 # 频域损失权重
  
  # SSIM Loss（辅助⭐⭐⭐）
  use_ssim: true
  ssim_weight: 0.5                      # SSIM损失权重

# ========== GAN配置（真正的对抗训练）⭐⭐⭐⭐⭐ ==========
gan:
  enabled: true                         # 启用GAN
  
  # 特征权重（多普勒为主，地杂波为辅）
  doppler_weight: 0.75                  # 多普勒特征权重
  clutter_weight: 0.25                  # 地杂波特征权重
  
  # 损失权重
  weights:
    gan: 0.5                            # ⬆️ GAN总损失权重（提高权重）
  
  # 对抗训练参数
  adversarial_weight: 1.0               # 对抗损失权重（判别真假）
  feature_matching_weight: 1.0          # 特征匹配损失权重（特征相似）
  
  # 训练设置
  train_discriminator: true             # ✅ 启用判别器训练（真正的对抗训练）
  lr_discriminator: 2e-4                # 判别器学习率
  discriminator_update_freq: 1          # 每N步更新一次判别器（1=每步都更新）

# ========== 训练配置 ==========
train:
  batch_size: 1                         # 批大小
  num_epochs: 1000                      # 训练轮数
  learning_rate: 5e-5                   # 生成器学习率
  num_workers: 4
  gradient_accumulation_steps: 16       # 梯度累积步数
  
  # 学习率调度
  lr_scheduler: "plateau"
  plateau_patience: 20
  plateau_factor: 0.7
  plateau_min_lr: 1.0e-6
  plateau_mode: "min"
  
  # 优化器
  optimizer: "adamw"
  weight_decay: 0.01
  betas: [0.9, 0.999]
  
  # 梯度裁剪
  max_grad_norm: 1.0
  
  # 设备
  device: "cuda"
  mixed_precision: false                # 混合精度（对抗训练建议关闭）
  
  # 保存和日志
  save_interval: 10
  log_interval: 10
  save_best_only: false
  keep_last_n_checkpoints: 5
  
  # 早停
  early_stopping:
    enabled: true
    patience: 30                        # ⬆️ 对抗训练需要更多耐心
    min_delta: 0.0001
    monitor: "val_loss"
  
  # 自动测试
  auto_test: true                       # 训练结束后自动测试

# ========== 推理配置 ==========
inference:
  ode_steps: 50
  ode_method: "euler"
  batch_size: 1
  save_intermediate: false
  intermediate_steps: [10, 20, 30, 40]

# ========== 路径配置 ==========
paths:
  output_dir: "./trained_models/outputs_gan/results"
  log_dir: "./trained_models/outputs_gan/logs"
  checkpoint_dir: "./trained_models/outputs_gan/checkpoints"

# ========== 恢复训练 ==========
resume:
  checkpoint: null

# ========== 其他配置 ==========
misc:
  seed: 42
  cudnn_benchmark: true
  deterministic: false


# ========================================================================
# 使用说明 - 真正的对抗训练版本
# ========================================================================
#
# 本配置文件用于真正的GAN对抗训练，关键改进：
#
# 【核心改进】：
# 1. ✅ 使用AdversarialDiscriminator替代原DopplerClutterDiscriminator
# 2. ✅ 判别器参与训练（train_discriminator: true）
# 3. ✅ 实现真正的对抗损失（判别真假）
# 4. ✅ 加入特征匹配损失（辅助）
# 5. ✅ 交替训练生成器和判别器
#
# 【训练模式】：
# - 判别器训练：区分真实图和生成图（二分类）
# - 生成器训练：欺骗判别器 + 特征匹配 + Flow Matching + 频域 + SSIM
#
# 【损失构成】：
# 生成器总损失 = 
#   1.0 × Flow_Matching_Loss +
#   2.0 × Frequency_Loss +
#   0.5 × SSIM_Loss +
#   0.5 × GAN_Loss
#     └─ GAN_Loss = 1.0 × Adversarial_Loss + 1.0 × Feature_Matching_Loss
#
# 【使用方法】：
# python train_v3_gan.py --config config_v3_gan.yaml
#
# 【预期效果】：
# - 判别器准确率：50%左右（平衡状态，说明生成器和判别器势均力敌）
# - 对抗损失：稳定在0.3-0.7之间
# - 频域相关系数：> 0.8（优秀）
# - 综合评分：> 85分（良好）
#
# 【调优建议】：
# 1. 如果判别器太强（准确率>70%）：
#    - 降低lr_discriminator到1e-4
#    - 增加discriminator_update_freq到2或3
#    - 提高gan_weight到0.8
#
# 2. 如果判别器太弱（准确率<30%）：
#    - 提高lr_discriminator到3e-4
#    - 降低discriminator_update_freq到1
#    - 降低gan_weight到0.3
#
# 3. 如果训练不稳定：
#    - 启用梯度惩罚（需要修改代码）
#    - 降低学习率
#    - 增加特征匹配权重
#
# ========================================================================
