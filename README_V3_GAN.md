# V3版本GAN功能说明

## GAN架构

### 生成器
- **Flow Matching模型**（现有模型，保持不变）
- 输入：仿真RD图
- 输出：生成的真实RD图

### 判别器
- **多普勒+地杂波判别器**（新增）
- 输入：真实RD图和生成RD图
- 输出：差别分数
- **重点**：多普勒效应（权重0.75）
- **次要**：地杂波/中间那条线（权重0.25）

## 判别器设计

### 1. 多普勒特征提取器（主要）

**功能**：在频域中提取多普勒十字特征

**实现**：
- FFT变换到频域
- 检测垂直方向（速度轴）能量集中
- 检测水平方向（距离轴）能量集中
- 提取多普勒十字区域
- CNN特征提取

**权重**：0.75（主要）

### 2. 地杂波特征提取器（次要）

**功能**：提取中间那条线（地杂波）

**实现**：
- 空间特征：提取中间几行（中心±2行）
- 频域特征：提取低频区域（地杂波主要在低频）
- 特征融合

**权重**：0.25（次要）

### 3. 特征判别器

**功能**：计算真实特征和生成特征的差别

**实现**：
- L2距离计算
- 最小化差别

## 损失函数

### 总损失

```python
total_loss = (
    loss_fm * 1.0 +                      # Flow Matching损失
    loss_frequency * 2.0 +               # 频域损失（现有）
    loss_ssim * 0.5 +                    # SSIM损失（现有）
    loss_gan * 0.3                       # GAN损失（新增，辅助）
)
```

### GAN损失

```python
loss_gan = (
    0.75 * doppler_diff +                # 多普勒差别（主要）
    0.25 * clutter_diff                  # 地杂波差别（次要）
)
```

## 配置

在 `config_v2.yaml` 中启用GAN：

```yaml
gan:
  enabled: true                          # 启用GAN
  doppler_weight: 0.75                   # 多普勒权重（主要）
  clutter_weight: 0.25                   # 地杂波权重（次要）
  weights:
    gan: 0.3                             # GAN损失权重（辅助）
  train_discriminator: false             # 是否训练判别器（false=只用于特征提取）
```

## 使用方法

### 训练（启用GAN）

```bash
python train_v3.py --config config_v2.yaml
```

确保配置文件中 `gan.enabled: true`

### 训练输出

训练时会显示：
- `train/loss_gan` - GAN总损失
- `train/loss_gan_doppler` - 多普勒差别损失
- `train/loss_gan_clutter` - 地杂波差别损失

## 关键特点

1. **不改变现有损失**：现有损失函数完全不变
2. **多普勒为主**：多普勒权重0.75，地杂波权重0.25
3. **训练稳定**：不是对抗训练，是差别计算
4. **辅助作用**：GAN损失权重较小（0.3），作为辅助

## 权重调整

### 如果多普勒效果不够好

```yaml
gan:
  doppler_weight: 0.8                    # 增加多普勒权重
  clutter_weight: 0.2                    # 降低地杂波权重
```

### 如果地杂波效果不够好

```yaml
gan:
  doppler_weight: 0.7                    # 降低多普勒权重
  clutter_weight: 0.3                    # 增加地杂波权重
```

### 如果GAN损失干扰训练

```yaml
gan:
  weights:
    gan: 0.1                             # 降低GAN权重
```

## 注意事项

1. **判别器不训练**：默认情况下，判别器只用于特征提取，不进行训练
2. **权重平衡**：多普勒权重远高于地杂波权重（0.75 vs 0.25）
3. **辅助作用**：GAN损失作为辅助，不主导训练
4. **训练稳定**：使用差别计算，而非对抗训练，训练更稳定

## 技术细节

### 多普勒区域检测

- 使用能量阈值法（前20%高能量）
- 检测垂直和水平方向的能量集中
- 组合为多普勒十字区域

### 地杂波区域检测

- 空间：中间几行（中心±2行）
- 频域：低频区域（中心20%）
- 结合空间和频域特征

### 特征提取

- 多普勒：CNN特征提取（64通道）
- 地杂波：空间+频域特征融合（32通道）
- 差别计算：L2距离

## 文件清单

- `utils_v3/discriminator.py` - 判别器实现
- `train_v3.py` - 训练脚本（集成GAN）
- `config_v2.yaml` - 配置文件（GAN配置）

## 总结

V3版本的GAN功能：
- ✅ 多普勒效应为主（权重0.75）
- ✅ 地杂波为辅（权重0.25）
- ✅ 不改变现有损失
- ✅ 训练稳定
- ✅ 易于调整

